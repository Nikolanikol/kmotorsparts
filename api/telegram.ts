import type { VercelRequest, VercelResponse } from '@vercel/node';


interface FormData {
  name: string;
  phone: string;
  email?: string;
  carModel?: string;
  vinNumber?: string;
  message?: string;
}

export default async function handler(req: VercelRequest, res: VercelResponse) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  const { name, phone, email, carModel, vinNumber, message } = req.body as FormData;

  if (!name || !phone) {
    return res.status(400).json({ error: 'Ð˜Ð¼Ñ Ð¸ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹' });
  }

  const botToken = process.env.TELEGRAM_BOT_TOKEN;
  const chatId = process.env.TELEGRAM_CHAT_ID;

  if (!botToken || !chatId) {
    console.error('Missing TELEGRAM_BOT_TOKEN or TELEGRAM_CHAT_ID');
    return res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ ÑÐµÑ€Ð²ÐµÑ€Ð°' });
  }

  const text = `ðŸ“¬ *ÐÐ¾Ð²Ð°Ñ Ð·Ð°ÑÐ²ÐºÐ° Ñ ÑÐ°Ð¹Ñ‚Ð°!*

ðŸ‘¤ *Ð˜Ð¼Ñ:* ${escapeMarkdown(name)}
ðŸ“ž *Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½:* ${escapeMarkdown(phone)}${email ? `\nðŸ“§ *Email:* ${escapeMarkdown(email)}` : ''}${carModel ? `\nðŸš— *ÐœÐ¾Ð´ÐµÐ»ÑŒ Ð°Ð²Ñ‚Ð¾:* ${escapeMarkdown(carModel)}` : ''}${vinNumber ? `\nðŸ”¢ *VIN Ð½Ð¾Ð¼ÐµÑ€:* ${escapeMarkdown(vinNumber)}` : ''}${message ? `\nðŸ’¬ *Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ:* ${escapeMarkdown(message)}` : ''}`;

  try {
    const response = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: chatId,
        text,
        parse_mode: 'Markdown',
      }),
    });

    const data = await response.json();

    if (!data.ok) {
      console.error('Telegram API error:', data);
      return res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð² Telegram' });
    }

    return res.status(200).json({ success: true });
  } catch (error) {
    console.error('Error sending to Telegram:', error);
    return res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ' });
  }
}

function escapeMarkdown(text: string): string {
  return text.replace(/[_*[\]()~`>#+=|{}.!-]/g, '\\$&');
}
